{% extends 'base_with_map.html' %}
{% load static %}

{% block extra_css %}
<style>
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    /* Animated Stats Cards */
    .stats-card {
        position: relative;
        overflow: hidden;
        border-radius: 15px !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
    }
    
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.6s ease;
    }
    
    .stats-card:hover::before {
        left: 100%;
    }
    
    .counter {
        font-weight: 900 !important;
        font-size: 3rem !important;
        position: relative;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        background: linear-gradient(45deg, currentColor, currentColor);
        -webkit-background-clip: text;
        background-clip: text;
    }
    
    .stats-section {
        padding: 80px 0 !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        position: relative;
    }
    
    .stats-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            radial-gradient(circle at 20% 80%, rgba(0,123,255,0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(40,167,69,0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(23,162,184,0.1) 0%, transparent 50%);
        pointer-events: none;
    }}
{% load map_tags %}

{% block title %}{% if query %}Search Results{% else %}ListAcross.eu - European Business Directory{% endif %}{% endblock %}

{% block description %}Find businesses across Europe. ListAcross.eu connects customers with verified businesses in all 27 EU countries. Search restaurants, hotels, shops, and services.{% endblock %}

{% block map_section %}
    {% dynamic_map 'europe' '' %}
{% endblock %}

{% block flag_section %}
    {% flag_slider %}
{% endblock %}

{% block extra_css %}
<!-- Bootstrap 5 for homepage components -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    /* Enhanced homepage styles */
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 60px 0 40px 0;
        margin-top: -20px; /* Integrate with map */
    }
    
    .search-box {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: var(--shadow);
        margin-top: -30px; /* Overlap with map section */
        position: relative;
        z-index: 10;
    }
    
    .category-card {
        border: none;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        height: 100%;
        border-radius: var(--radius);
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .stats-section {
        background: var(--bg);
        padding: 60px 0;
    }
    
    .business-card {
        border: none;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        height: 100%;
        border-radius: var(--radius);
    }
    
    .business-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .cta-section {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 60px 0;
    }
    
    /* Bootstrap integration */
    .container {
        max-width: 1180px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Enhanced search section that integrates with map -->
<div class="search-box mx-auto" style="max-width: 900px;">
    <form method="GET" class="row g-3">
        <div class="col-md-5">
            <input type="text" class="form-control form-control-lg" name="query" 
                   value="{{ query }}" placeholder="🔍 Search businesses, services...">
        </div>
        <div class="col-md-3">
            <select class="form-select form-select-lg" name="city">
                <option value="">All Cities</option>
                {% for city in popular_cities %}
                <option value="{{ city.id }}" {% if city.id|stringformat:"s" == selected_city_id %}selected{% endif %}>
                    {{ city.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" name="category">
                <option value="">All Categories</option>
                {% for category in featured_categories %}
                <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category_id %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
    </form>
</div>

{% if not query %}
<!-- Stats Section -->
<section class="stats-section">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card category-card stats-card">
                    <div class="card-body">
                        <div class="display-6 text-primary fw-bold counter" data-target="{{ stats.total_businesses }}">0</div>
                        <h6 class="card-title">Businesses Listed</h6>
                        <p class="card-text text-muted">Verified companies across Europe</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card category-card stats-card">
                    <div class="card-body">
                        <div class="display-6 text-success fw-bold counter" data-target="{{ stats.total_cities }}">0</div>
                        <h6 class="card-title">Cities Covered</h6>
                        <p class="card-text text-muted">Major European cities</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card category-card stats-card">
                    <div class="card-body">
                        <div class="display-6 text-info fw-bold counter" data-target="{{ stats.total_categories }}">0</div>
                        <h6 class="card-title">Business Categories</h6>
                        <p class="card-text text-muted">From restaurants to tech companies</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Featured Categories -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">Popular Categories</h2>
        <div class="row">
            {% for category in featured_categories %}
            <div class="col-md-4 mb-4">
                <a href="{% url 'homepage' %}?category={{ category.id }}" class="text-decoration-none">
                    <div class="card category-card">
                        <div class="card-body text-center">
                            <i class="fas fa-briefcase fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">{{ category.name }}</h5>
                            <p class="card-text text-muted">{{ category.business_count }} businesses</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Popular Cities -->
<section class="stats-section">
    <div class="container">
        <h2 class="text-center mb-5">Popular Destinations</h2>
        <div class="row">
            {% for city in popular_cities %}
            <div class="col-md-3 col-sm-6 mb-4">
                <a href="{% url 'homepage' %}?city={{ city.id }}" class="text-decoration-none">
                    <div class="card category-card">
                        <div class="card-body text-center">
                            <h6 class="card-title">{{ city.name }}</h6>
                            <small class="text-muted">{{ city.country.name }}</small>
                            <div class="mt-2">
                                <span class="badge bg-primary">{{ city.business_count }} businesses</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

{% else %}
<!-- Search Results -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12 mb-4">
                <h2>Search Results for "{{ query }}"</h2>
                <p class="text-muted">Found {{ businesses.paginator.count }} businesses</p>
            </div>
        </div>
        
        {% if businesses %}
        <div class="row">
            {% for business in businesses %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card business-card">
                    <div class="card-body">
                        <h6 class="card-title">{{ business.name }}</h6>
                        <p class="card-text text-muted">{{ business.category.name }}</p>
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ business.city.name }}, {{ business.city.country.name }}
                            </small>
                        </p>
                        {% if business.description %}
                        <p class="card-text">{{ business.description|truncatewords:15 }}</p>
                        {% endif %}
                        <a href="{% url 'business_detail' business.slug %}" class="btn btn-primary btn-sm">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if businesses.has_other_pages %}
        <nav aria-label="Search results pagination">
            <ul class="pagination justify-content-center">
                {% if businesses.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}page={{ businesses.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}
                
                {% for num in businesses.paginator.page_range %}
                    {% if businesses.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > businesses.number|add:'-3' and num < businesses.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if businesses.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}page={{ businesses.next_page_number }}">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-4x text-muted mb-3"></i>
            <h4>No businesses found</h4>
            <p class="text-muted">Try adjusting your search terms or browse by category.</p>
            <a href="{% url 'homepage' %}" class="btn btn-primary">Browse All Businesses</a>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section class="cta-section">
    <div class="container text-center">
        <h2 class="mb-4">Ready to List Your Business?</h2>
        <p class="lead mb-4">Join thousands of European businesses already on our platform</p>
        <a href="{% url 'register_business' %}" class="btn btn-light btn-lg">
            <i class="fas fa-plus me-2"></i>List Your Business Free
        </a>
    </div>
</section>

{% endblock %}

{% block extra_head %}
<!-- JSON-LD Structured Data for Homepage -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "ListAcross Europe",
    "alternateName": "ListAcross.eu",
    "url": "{{ request.build_absolute_uri }}",
    "description": "European business directory connecting customers with verified businesses across all 27 EU countries. Find restaurants, hotels, services, and companies.",
    "potentialAction": {
        "@type": "SearchAction",
        "target": {
            "@type": "EntryPoint",
            "urlTemplate": "{{ request.build_absolute_uri }}?query={search_term_string}"
        },
        "query-input": "required name=search_term_string"
    },
    "mainEntity": {
        "@type": "Organization",
        "name": "ListAcross Europe",
        "url": "{{ request.build_absolute_uri }}",
        "logo": "{{ request.build_absolute_uri }}{% static 'images/logo.png' %}",
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "Customer Service",
            "areaServed": ["AT", "BE", "BG", "HR", "CY", "CZ", "DK", "EE", "FI", "FR", "DE", "GR", "HU", "IE", "IT", "LV", "LT", "LU", "MT", "NL", "PL", "PT", "RO", "SK", "SI", "ES", "SE"],
            "availableLanguage": ["English", "German", "French", "Spanish", "Italian", "Portuguese"]
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "reviewCount": "{{ stats.total_businesses }}",
            "bestRating": "5",
            "worstRating": "1"
        }
    },
    "about": {
        "@type": "Thing",
        "name": "European Business Directory",
        "description": "Comprehensive directory of {{ stats.total_businesses }} businesses across {{ stats.total_cities }} cities in 27 European Union countries"
    },
    "keywords": "European business directory, EU companies, restaurants Europe, hotels Europe, services Europe, businesses Austria, Belgium, Bulgaria, Croatia, Cyprus, Czech Republic, Denmark, Estonia, Finland, France, Germany, Greece, Hungary, Ireland, Italy, Latvia, Lithuania, Luxembourg, Malta, Netherlands, Poland, Portugal, Romania, Slovakia, Slovenia, Spain, Sweden"
}
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Enhanced homepage functionality with counter animation
    document.addEventListener('DOMContentLoaded', function() {
        // Animated counter function
        function animateCounter(element) {
            const target = parseInt(element.dataset.target);
            let current = 0;
            const increment = target / 100; // Adjust speed here
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = target.toLocaleString();
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current).toLocaleString();
                }
            }, 20); // Animation speed (20ms intervals)
        }

        // Initialize counter animation when stats come into view
        const observerOptions = {
            threshold: 0.5,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const counters = entry.target.querySelectorAll('.counter');
                    counters.forEach((counter, index) => {
                        setTimeout(() => {
                            animateCounter(counter);
                        }, index * 300); // Stagger animations by 300ms
                    });
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        // Observe stats section
        const statsSection = document.querySelector('.stats-section');
        if (statsSection) {
            observer.observe(statsSection);
        }
        
        // Focus on search input
        const searchInput = document.querySelector('input[name="query"]');
        if (searchInput && !searchInput.value) {
            searchInput.focus();
        }
        
        // Add search enhancement
        const searchForm = document.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                const query = searchInput.value.trim();
                if (!query) {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.setAttribute('placeholder', '⚠️ Please enter a search term');
                    setTimeout(() => {
                        searchInput.setAttribute('placeholder', '🔍 Search businesses, services...');
                    }, 3000);
                }
            });
        }
        
        console.log('Enhanced homepage with animated counters loaded');
    });
</script>
{% endblock %}