{% extends 'base_with_map.html' %}
{% load static %}
{% load map_tags %}

{% block title %}{% if query %}Search Results{% else %}ListAcross.eu - European Business Directory{% endif %}{% endblock %}

{% block description %}Find businesses across Europe. ListAcross.eu connects customers with verified businesses in all 27 EU countries. Search restaurants, hotels, shops, and services.{% endblock %}

{% block map_section %}
    {% dynamic_map 'europe' '' %}
{% endblock %}

{% block flag_section %}
    {% flag_slider %}
{% endblock %}

{% block extra_css %}
<!-- Bootstrap 5 for homepage components -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    /* Enhanced homepage styles */
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 60px 0 40px 0;
        margin-top: -20px; /* Integrate with map */
    }
    
    .search-box {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: var(--shadow);
        margin-top: -30px; /* Overlap with map section */
        position: relative;
        z-index: 10;
    }
    
    .category-card {
        border: none;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        height: 100%;
        border-radius: var(--radius);
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .stats-section {
        background: var(--bg);
        padding: 60px 0;
    }
    
    .business-card {
        border: none;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        height: 100%;
        border-radius: var(--radius);
    }
    
    .business-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .cta-section {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 60px 0;
    }
    
    /* Bootstrap integration */
    .container {
        max-width: 1180px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Enhanced search section that integrates with map -->
<div class="search-box mx-auto" style="max-width: 900px;">
    <form method="GET" class="row g-3">
        <div class="col-md-5">
            <input type="text" class="form-control form-control-lg" name="query" 
                   value="{{ query }}" placeholder="🔍 Search businesses, services...">
        </div>
        <div class="col-md-3">
            <select class="form-select form-select-lg" name="city">
                <option value="">All Cities</option>
                {% for city in popular_cities %}
                <option value="{{ city.id }}" {% if city.id|stringformat:"s" == selected_city_id %}selected{% endif %}>
                    {{ city.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select form-select-lg" name="category">
                <option value="">All Categories</option>
                {% for category in featured_categories %}
                <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category_id %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
    </form>
</div>

{% if not query %}
<!-- Stats Section -->
<section class="stats-section">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card category-card">
                    <div class="card-body">
                        <div class="display-6 text-primary fw-bold">{{ stats.total_businesses }}</div>
                        <h6 class="card-title">Businesses Listed</h6>
                        <p class="card-text text-muted">Verified companies across Europe</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card category-card">
                    <div class="card-body">
                        <div class="display-6 text-success fw-bold">{{ stats.total_cities }}</div>
                        <h6 class="card-title">Cities Covered</h6>
                        <p class="card-text text-muted">Major European cities</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card category-card">
                    <div class="card-body">
                        <div class="display-6 text-info fw-bold">{{ stats.total_categories }}</div>
                        <h6 class="card-title">Business Categories</h6>
                        <p class="card-text text-muted">From restaurants to tech companies</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Featured Categories -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">Popular Categories</h2>
        <div class="row">
            {% for category in featured_categories %}
            <div class="col-md-4 mb-4">
                <a href="{% url 'homepage' %}?category={{ category.id }}" class="text-decoration-none">
                    <div class="card category-card">
                        <div class="card-body text-center">
                            <i class="fas fa-briefcase fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">{{ category.name }}</h5>
                            <p class="card-text text-muted">{{ category.business_count }} businesses</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Popular Cities -->
<section class="stats-section">
    <div class="container">
        <h2 class="text-center mb-5">Popular Destinations</h2>
        <div class="row">
            {% for city in popular_cities %}
            <div class="col-md-3 col-sm-6 mb-4">
                <a href="{% url 'homepage' %}?city={{ city.id }}" class="text-decoration-none">
                    <div class="card category-card">
                        <div class="card-body text-center">
                            <h6 class="card-title">{{ city.name }}</h6>
                            <small class="text-muted">{{ city.country.name }}</small>
                            <div class="mt-2">
                                <span class="badge bg-primary">{{ city.business_count }} businesses</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

{% else %}
<!-- Search Results -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12 mb-4">
                <h2>Search Results for "{{ query }}"</h2>
                <p class="text-muted">Found {{ businesses.paginator.count }} businesses</p>
            </div>
        </div>
        
        {% if businesses %}
        <div class="row">
            {% for business in businesses %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card business-card">
                    <div class="card-body">
                        <h6 class="card-title">{{ business.name }}</h6>
                        <p class="card-text text-muted">{{ business.category.name }}</p>
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ business.city.name }}, {{ business.city.country.name }}
                            </small>
                        </p>
                        {% if business.description %}
                        <p class="card-text">{{ business.description|truncatewords:15 }}</p>
                        {% endif %}
                        <a href="{% url 'business_detail' business.slug %}" class="btn btn-primary btn-sm">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if businesses.has_other_pages %}
        <nav aria-label="Search results pagination">
            <ul class="pagination justify-content-center">
                {% if businesses.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}page={{ businesses.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}
                
                {% for num in businesses.paginator.page_range %}
                    {% if businesses.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > businesses.number|add:'-3' and num < businesses.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if businesses.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_category_id %}category={{ selected_category_id }}&{% endif %}page={{ businesses.next_page_number }}">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-4x text-muted mb-3"></i>
            <h4>No businesses found</h4>
            <p class="text-muted">Try adjusting your search terms or browse by category.</p>
            <a href="{% url 'homepage' %}" class="btn btn-primary">Browse All Businesses</a>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section class="cta-section">
    <div class="container text-center">
        <h2 class="mb-4">Ready to List Your Business?</h2>
        <p class="lead mb-4">Join thousands of European businesses already on our platform</p>
        <a href="{% url 'register_business' %}" class="btn btn-light btn-lg">
            <i class="fas fa-plus me-2"></i>List Your Business Free
        </a>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Enhanced homepage functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Focus on search input
        const searchInput = document.querySelector('input[name="query"]');
        if (searchInput && !searchInput.value) {
            searchInput.focus();
        }
        
        // Add search enhancement
        const searchForm = document.querySelector('form');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                const query = searchInput.value.trim();
                if (!query) {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.setAttribute('placeholder', '⚠️ Please enter a search term');
                    setTimeout(() => {
                        searchInput.setAttribute('placeholder', '🔍 Search businesses, services...');
                    }, 3000);
                }
            });
        }
        
        console.log('Enhanced homepage with dynamic map and flag slider loaded');
    });
</script>
{% endblock %}